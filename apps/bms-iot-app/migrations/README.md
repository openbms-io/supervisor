# Database Migration Guide

This guide covers database schema management for the BMS IoT application using **Alembic + SQLModel**, following SQLModel's official recommendation for production systems.

> **SQLModel Official Guidance**: "For a production system you would probably want to use a system to migrate the database" rather than using simple `create_all()`.

## Quick Start

### Prerequisites
- Alembic is installed (`pip install alembic`)
- SQLModel models are defined with `table=True`
- All models are imported in `migrations/env.py`

### ‚úÖ Complete Migration Coverage
**ALL database tables are now managed by Alembic migrations:**
- `controller_points` - BACnet device controller point data (41 columns with optional properties)
- `deployment_config` - Device deployment configuration
- `iot_device_status` - IoT device status and metrics
- `bacnet_config` - BACnet device configuration
- `bacnet_readers` - BACnet reader configuration
- `alembic_version` - Migration version tracking

### **IMPORTANT: Manual Migration Workflow**

The application now uses **manual migrations** for production safety:

```bash
# 1. Make changes to SQLModel classes
# 2. Generate migration
alembic revision --autogenerate -m "describe your changes"

# 3. Review generated migration file in versions/
# 4. Apply migration BEFORE starting the application
alembic upgrade head

# 5. Start the application
python -m src.main
```

**‚ö†Ô∏è Critical**: Always run `alembic upgrade head` before starting the application!

## Adding New Columns to Existing Tables

### Step-by-Step Process

#### 1. Update SQLModel Class
Add the new column to your SQLModel class:

```python
# In src/models/your_model.py
class YourModel(SQLModel, table=True):
    __tablename__ = "your_table"

    # existing columns...
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(description="Existing column")

    # NEW COLUMN - add this
    new_column: Optional[str] = Field(
        default=None,
        description="Description of new column"
    )
```

#### 2. Generate Migration
```bash
alembic revision --autogenerate -m "add new_column to your_table"
```

This creates a file like `versions/abc123_add_new_column_to_your_table.py`

#### 3. Review Generated Migration
```python
def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('your_table', sa.Column('new_column', sqlmodel.sql.sqltypes.AutoString(), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('your_table', 'new_column')
    # ### end Alembic commands ###
```

**‚ö†Ô∏è Always review migrations before applying!**

#### 4. Apply Migration
```bash
alembic upgrade head
```

#### 5. Verify Schema Changes
```bash
# Check current migration status
alembic current

# Verify column was added
sqlite3 ../../bms_bacnet.db "PRAGMA table_info(your_table);"
```

## Adding New Tables

### Step-by-Step Process

#### 1. Create New SQLModel Class
```python
# In src/models/new_table.py
from sqlmodel import SQLModel, Field
from typing import Optional
from datetime import datetime, timezone

class NewTableModel(SQLModel, table=True):
    __tablename__ = "new_table"

    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(description="Table name")
    created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))

    # Add your columns here...
```

#### 2. Import Model in Migration Environment
Add import to `migrations/env.py`:

```python
# Import all SQLModel models so Alembic can detect them
from src.models.controller_points import ControllerPointsModel
from src.models.new_table import NewTableModel  # ADD THIS LINE
```

#### 3. Generate Migration
```bash
alembic revision --autogenerate -m "create new_table"
```

#### 4. Review and Apply
```bash
# Review the generated migration file
# Then apply:
alembic upgrade head
```

## Real Example: Optional BACnet Properties

Here's the actual migration we used to add 24 optional BACnet property columns:

### Before (SQLModel)
```python
class ControllerPointsModel(SQLModel, table=True):
    # ... existing columns
    status_flags: Optional[str] = Field(default=None)

    # Added 24 new columns:
    min_pres_value: Optional[float] = Field(default=None)
    max_pres_value: Optional[float] = Field(default=None)
    high_limit: Optional[float] = Field(default=None)
    # ... 21 more columns
```

### Migration Generated
```bash
alembic revision --autogenerate -m "add optional bacnet properties"
```

### Result
- **Before**: 18 columns in controller_points table
- **After**: 41 columns in controller_points table
- **Migration**: `dc3c962443cb_add_optional_bacnet_properties.py`

## Command Reference

### Essential Commands
```bash
# Initialize Alembic (already done)
alembic init -t async migrations

# Generate new migration
alembic revision --autogenerate -m "description"

# Apply all pending migrations
alembic upgrade head

# Apply specific migration
alembic upgrade <revision_id>

# Show current migration
alembic current

# Show migration history
alembic history

# Rollback to previous migration
alembic downgrade -1

# Rollback to specific migration
alembic downgrade <revision_id>
```

### Advanced Commands
```bash
# Create empty migration (for manual changes)
alembic revision -m "manual migration"

# Show pending migrations
alembic show <revision_id>

# Generate SQL without applying
alembic upgrade head --sql

# Mark database as being at specific revision (without running migration)
alembic stamp <revision_id>
```

## Development Workflow Integration

### Application Startup Integration
The application NO LONGER runs automatic migrations for production safety:

```python
# In src/main.py - UPDATED APPROACH
async def create_local_db():
    """Initialize database schema.

    IMPORTANT: Run 'alembic upgrade head' BEFORE starting the application.

    All database tables are now managed by Alembic migrations for proper version control
    and production safety. This function is kept for backward compatibility but no longer
    creates tables manually.
    """
    logger.info("Database initialization: All tables managed by Alembic migrations")
    logger.info("IMPORTANT: Ensure 'alembic upgrade head' was run before starting the application")
    logger.info("If tables are missing, run: alembic upgrade head")
```

**New Workflow**: Complete manual migration control for production safety

### Testing Migrations Locally
```bash
# 1. Create test copy of database
cp ../../bms_bacnet.db ../../bms_bacnet_test.db

# 2. Test migration on copy
# (modify alembic.ini temporarily to point to test DB)
alembic upgrade head

# 3. Verify results
sqlite3 ../../bms_bacnet_test.db "PRAGMA table_info(your_table);"
```

## Best Practices

### SQLModel Design for Migrations
1. **Always use Optional for new columns**: Existing data won't have values
2. **Provide defaults**: `Field(default=None)` or `Field(default_factory=func)`
3. **Use descriptive Field descriptions**: Helps understand column purpose
4. **Follow naming conventions**: Use snake_case for database columns

### Migration Best Practices
1. **Review before applying**: Auto-generated migrations need human review
2. **Backup before major changes**: `cp bms_bacnet.db bms_bacnet.backup`
3. **Test locally first**: Always test migrations on development database
4. **Incremental changes**: Small, focused migrations are easier to troubleshoot
5. **Descriptive messages**: Good migration messages help with debugging

### Team Collaboration
1. **Commit migrations with code changes**: Keep schema and code in sync
2. **Coordinate schema changes**: Communicate breaking changes to team
3. **Document breaking changes**: Update this README for complex migrations

## Troubleshooting

### Common Issues

#### Import Errors
```
ModuleNotFoundError: No module named 'packages'
```
**Solution**: The `migrations/env.py` adds project root to Python path. If you get import errors, check the path configuration:

```python
# In migrations/env.py
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), "..", ".."))
if project_root not in sys.path:
    sys.path.insert(0, project_root)
```

#### Wrong Database Path
Migrations apply to wrong database file.

**Solution**: Check `alembic.ini` database URL:
```ini
sqlalchemy.url = sqlite+aiosqlite:///../../bms_bacnet.db
```

#### Migration Already Applied
```
Target database is not up to date.
```
**Solution**: Check current revision and history:
```bash
alembic current
alembic history
```

### Database Recovery
If migration fails and corrupts database:

```bash
# 1. Restore from backup
cp bms_bacnet.db.backup bms_bacnet.db

# 2. Check migration status
alembic current

# 3. Manual fix or rollback
alembic downgrade <previous_revision>
```

## Configuration Files

### `alembic.ini`
Main configuration file:
```ini
[alembic]
script_location = %(here)s/migrations
sqlalchemy.url = sqlite+aiosqlite:///../../bms_bacnet.db
```

### `migrations/env.py`
Environment configuration with complete SQLModel integration:
- Imports ALL SQLModel models (controller_points, iot_device_status, deployment_config, bacnet_config, bacnet_readers)
- Sets `target_metadata = SQLModel.metadata`
- Handles async database connections
- Manages Python path for monorepo imports (packages/ directory access)

### `migrations/script.py.mako`
Template for generated migration files:
- Includes SQLModel imports
- Provides upgrade/downgrade structure

## Production Deployment

### Pre-Deployment Checklist
- [ ] Migrations tested locally
- [ ] Database backed up
- [ ] Migration files committed to version control
- [ ] Breaking changes documented
- [ ] Rollback plan prepared
- [ ] **CRITICAL**: `alembic upgrade head` will be run BEFORE starting app

### Local/Manual Deployment Process
1. **Stop application** (if running)
2. **Backup database**: `cp bms_bacnet.db bms_bacnet.backup`
3. **Apply migrations**: `alembic upgrade head` ‚ö†Ô∏è **MANDATORY STEP**
4. **Verify schema**: Check critical tables/columns exist
5. **Start application**: `python -m src.main`
6. **Monitor logs** for migration-related errors

### Docker Deployment Process

**‚úÖ AUTOMATIC MIGRATION**: Docker containers now automatically run migrations before starting the application!

#### Starting Application Container
```bash
# Standard startup - migrations run automatically
docker compose up

# Or with docker run
docker run --name bms-iot-app -v bms_data:/data bms-iot-app:latest run-main
```

The container will:
1. Check provisioning status
2. **Automatically run** `alembic upgrade head`
3. Start the BMS IoT application
4. Exit with error if migrations fail

#### Manual Migration Commands
```bash
# Run migrations only (without starting app)
docker run --rm -v bms_data:/data bms-iot-app:latest migrate

# Check provisioning status
docker run --rm -v bms_data:/data bms-iot-app:latest check-provisioning

# Interactive shell for debugging
docker run --rm -it -v bms_data:/data bms-iot-app:latest bash
```

#### Docker Migration Features
- **Automatic migration** before app startup
- **Error handling**: Container won't start if migrations fail
- **Provisioning awareness**: Handles missing tables during provisioning
- **Manual migration command** for maintenance
- **Volume persistence**: Database and migrations stored in `/data` volume

**‚ö†Ô∏è CRITICAL**: The application will NOT work correctly if migrations are not applied first!

## Migration System Summary

### ‚úÖ What We've Accomplished

1. **Complete Alembic Integration**: All 6 database tables now managed by Alembic migrations
2. **Production-Safe Workflow**: Manual migration control prevents accidental schema changes
3. **Docker Integration**: Containers automatically run migrations before starting the application
4. **Test Integration**: Tests use SQLModel.metadata.create_all() for simplicity while production uses Alembic
5. **Comprehensive Documentation**: Step-by-step guides for all migration scenarios

### üìä Migration Statistics

- **Total Tables**: 6 (all managed by Alembic)
- **Total Migrations**: 2 migration files
- **Schema Evolution**: From 18 to 41 columns in controller_points table
- **Optional Properties**: 24 BACnet optional properties added
- **Test Coverage**: 186 tests passing with new migration system

### üîß System Architecture

```
Production Flow:
1. Code changes to SQLModel classes
2. Generate migration: `alembic revision --autogenerate -m "description"`
3. Review and test migration
4. Deploy with: `alembic upgrade head`
5. Start application

Docker Flow:
1. Container starts
2. Automatic `alembic upgrade head`
3. Application starts with up-to-date schema

Test Flow:
1. SQLModel.metadata.create_all() creates test tables
2. Tests run against current model definitions
3. Temporary test database used
```

## Getting Help

- **SQLModel Documentation**: https://sqlmodel.tiangolo.com/
- **Alembic Documentation**: https://alembic.sqlalchemy.org/
- **Project Issues**: Check logs in `logs/` directory

---

*This migration system follows SQLModel's official recommendation for production database management and ensures safe, trackable schema evolution across all environments.*
